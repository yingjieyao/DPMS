#coding=utf8

from django.shortcuts import render, render_to_response
from django.http import HttpResponse, HttpResponseRedirect
from django.template import RequestContext
from django import forms
from models import User

class UserForm(forms.Form):
    username = forms.CharField(label='用户名', max_length=50)
    password = forms.CharField(label='密码', widget=forms.PasswordInput())


def index(req):
    username = req.COOKIES.get('username', '')
    return render_to_response('index.html', {'username': username})

def login(req):
    username = req.COOKIES.get('username', '')
    if username:
        response = HttpResponseRedirect('/dpms/index/')
        response.set_cookie('username', username, 3600)
        return response

    if req.method == 'POST':
        user_form = UserForm(req.POST)
        if user_form.is_valid():
            username = user_form.cleaned_data['username']
            password = user_form.cleaned_data['password']
            user = User.objects.filter(username__exact=username, password__exact=password)
            if user:
                response = HttpResponseRedirect('/dpms/index/')
                response.set_cookie('username', username, 3600)
                return response
            else:
                return HttpResponseRedirect('/dpms/login/')
    else:
        user_form = UserForm()
    return render_to_response('login.html', {'user_form': user_form}, context_instance=RequestContext(req))

def regist(req):
    if req.method == 'POST':
        user_form = UserForm(req.POST)
        if user_form.is_valid():
            username = user_form.cleaned_data['username']
            password = user_form.cleaned_data['password']
            has = User.objects.get(username=username)
            if has:
                response = HttpResponse('temp.html')
            else:
                User.objects.create(username=username, password=password)
                response = HttpResponse('regist success!! <a href="/dpms/login/"> login </a>')
                response.set_cookie('username', username, 3600)
                return response
    else:
        user_form = UserForm()
    return render_to_response('regist.html', {'user_form': user_form}, context_instance=RequestContext(req))

def logout(req):
    response = HttpResponse("LOG OUT")
    response.delete_cookie("username")
    return response
